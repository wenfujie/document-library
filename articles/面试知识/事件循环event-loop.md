
## 任务队列和Event Loop（事件循环）
javascript 是单线程的，处理异步场景时，不可能让进程阻塞在那等待，所以就引出了用来存放异步任务的 `任务队列` 和 `事件循环` 的概念。

### 任务队列

所有任务可以分成两种，一种是同步任务（synchronous），另一种是异步任务（asynchronous）。同步任务指的是，在主线程上排队执行的任务，只有前一个任务执行完毕，才能执行后一个任务。异步任务指的是，不进入主线程、而进入"任务队列"（task
queue）的任务，只有"任务队列"通知主线程，某个异步任务可以执行了，该任务才会进入主线程执行。

总结： **只要主线程空了，就会去读取"任务队列"，这就是JavaScript的运行机制** 。【重要】

### Event Loop

主线程从"任务队列"中读取事件，这个过程是循环不断的，所以整个的这种运行机制又称为Event Loop（事件循环）。

[![](https://camo.githubusercontent.com/70c3b08db1c47192ffbeb0313be06f99596827f217a431aff27a97a38d48387b/687474703a2f2f696d672e736d79687661652e636f6d2f32303138303331305f313834302e706e67)](https://camo.githubusercontent.com/70c3b08db1c47192ffbeb0313be06f99596827f217a431aff27a97a38d48387b/687474703a2f2f696d672e736d79687661652e636f6d2f32303138303331305f313834302e706e67)

在理解Event Loop时，要理解两句话：

  * 理解哪些语句会放入异步任务队列

  * 理解语句放入异步任务队列的 **时机**

### 容易答错的题目

    
    
        for (var i = 0; i < 3; i++) {
            setTimeout(function () {
                console.log(i);
            }, 1000);
        }

很多人以为上面的题目，答案是`0,1,2,3`。其实，正确的答案是：`3,3,3,3`。

分析：for
循环是同步任务，setTimeout是异步任务。for循环每次遍历的时候，遇到settimeout，就先暂留着，等同步任务全部执行完毕（此时，i已经等于3了），再执行异步任务。

我们把上面的题目再加一行代码。最终代码如下：

    
    
        for (var i = 0; i < 3; i++) {
            setTimeout(function () {
                console.log(i);
            }, 1000);
        }
        console.log(i);

如果我们约定，用箭头表示其前后的两次输出之间有 1
秒的时间间隔，而逗号表示其前后的两次输出之间的时间间隔可以忽略，代码实际运行的结果该如何描述？可能会有两种答案：

  * A. 60% 的人会描述为：`3 -> 3 -> 3 -> 3`，即每个 3 之间都有 1 秒的时间间隔；

  * B. 40% 的人会描述为：`3 -> 3,3,3`，即第 1 个 3 直接输出，1 秒之后，连续输出 3 个 3。

循环执行过程中，几乎同时设置了 3 个定时器，这些定时器都会在 1 秒之后触发，而循环完的输出是立即执行的，显而易见，正确的描述是 B。

**参考**

https://github.com/qianguyihao/Web/blob/master/13-%E5%89%8D%E7%AB%AF%E9%9D%A2%E8%AF%95/01-%E9%9D%A2%E8%AF%95%E5%BF%85%E7%9C%8B/10-js%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6%EF%BC%9A%E5%BC%82%E6%AD%A5%E5%92%8C%E5%8D%95%E7%BA%BF%E7%A8%8B.md